#!/bin/bash
# Auto set CPU affinity for dwc_otg/mpd/squeezelite

# set -x

player=${1:-mpd} # could be mpd/squeezelite
lwp_num=${2:-3}

waitfor(){
  proc=$1
  expect_lwp_num=${2:-1}
  timeout=${3:-10}
  for c in $(seq 1 ${timeout});do
    lwp_num=$(ps -eL -o pid,lwp,comm,args | grep -Pi -- ${proc} | grep -Pv 'grep|systemctl|sudo|/bin/bash' | wc -l)
    if [[ ${lwp_num} -lt ${expect_lwp_num} ]] ;then
      echo "# Wait for ${proc} $c/$timeout"
      sleep 1 && continue
    else
      break
    fi
  done
}


echo "#  Re-Schedule ${player} ...."
sleep 1 # wait for startup ...
waitfor ${player} ${lwp_num}

case "${player}" in
  mpd)
    # Sometimes... rtio_tid/output_tid not appear, for safety set master process first
    export master_pid=$(pidof mpd)
    echo "# Change MPD master process affinity..."
    taskset -p --cpu-list 2-3  $master_pid

    rtio_tid=$(pstree -Aup $master_pid| grep rtio| grep -Po '\d+')
    output_tid=$(pstree -Aup $master_pid| grep output| grep -Po '\d+')
    if [[ -n $rtio_tid ]];then
      echo "# Change mpd:rtio thread affinity..."
      taskset -p --cpu-list 2  $rtio_tid
    fi
    if [[ -n $output_tid ]];then
      echo "# Change mpd:output thread affinity..."
      taskset -p --cpu-list 3  $output_tid
    fi

    echo "# Change other mpd low-prio thread affinity to spread all cpus ..."
    ps -eL -o lwp,psr,cls,comm,args|awk '($5~"mpd" && ($4=="mpd" || $4=="player" || $4~"decoder" || $4=="io" || $4=="update")){print $1}'| while read tid;
    do
      taskset -p --cpu-list 0-3  $tid
    done
  ;;
  squeezelite)
    ps -eL -o lwp,psr,comm,args | grep -Pi -- "${player}" | grep -Pv 'grep|systemctl|sudo|/bin/bash' | awk '{print $1}' | while read tid;
    do
      taskset -p --cpu-list 2-3  $tid
    done
  ;;

esac

echo "#  Final CPU Affinity status for dwc_otg/${player}:"
ps -q $(pgrep -d, 'dwc_otg|mpd|squeezelite') -eL -o class,pid,lwp,psr,rtprio,pri,nice,sched,comm,args

